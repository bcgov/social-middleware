# MongoDB TLS Encryption Setup

This document describes the MongoDB TLS encryption implementation for the social-middleware application.

## Overview

MongoDB has been configured to use TLS encryption for all connections between the NestJS middleware and MongoDB database. This setup uses OpenShift's service-serving certificates for automatic certificate management.

## Architecture

```
┌─────────────────────┐         TLS Encrypted          ┌──────────────────┐
│  NestJS Middleware  │ ◄──────────────────────────► │   MongoDB Pod    │
│                     │    Certificate Validation      │                  │
│  - Mongoose client  │                                │  - TLS enabled   │
│  - CA cert mounted  │                                │  - preferTLS     │
└─────────────────────┘                                └──────────────────┘
         │                                                      │
         │                                                      │
         ▼                                                      ▼
  mongodb-ca-bundle                                    mongodb-tls secret
   (ConfigMap)                                         (auto-generated)
```

## Changes Made

### 1. Database Module (`src/database/database.module.ts`)

**What Changed:**
- Added support for TLS configuration via environment variables
- Implemented CA certificate validation
- Added `authSource` parameter to connection string for proper authentication

**Key Features:**
- Reads `MONGO_USE_TLS` to enable/disable TLS
- Uses `MONGO_TLS_CA_FILE` to specify CA certificate path
- Falls back to `tlsAllowInvalidCertificates` for local development if CA file is missing
- Specifies `authSource` to match the database where the user was created

**Connection String Format:**
```
mongodb://[user]:[pass]@[host]:[port]/[database]?authSource=[database]
```

### 2. Environment Configuration (`.env.example`)

**Added Variables:**
```env
MONGO_USE_TLS=false
MONGO_TLS_CA_FILE=/etc/mongodb-ca/service-ca.crt
```

**Environment-Specific Values:**

| Environment | MONGO_HOST | MONGO_USE_TLS | MONGO_TLS_CA_FILE |
|-------------|------------|---------------|-------------------|
| Local Dev | `localhost` | `false` | Not required |
| OpenShift | `mongodb.f6e00d-dev.svc` | `true` | `/etc/mongodb-ca/service-ca.crt` |

### 3. Helm Deployment (`social-middleware-helm/templates/nextjs-deployment.yaml`)

**What Changed:**
- Added explicit `MONGO_HOST` environment variable with fully qualified domain name (FQDN)
- Added `MONGO_PORT`, `MONGO_USE_TLS`, and `MONGO_TLS_CA_FILE` environment variables
- Mounted `mongodb-ca-bundle` ConfigMap at `/etc/mongodb-ca`

**Volume Mount:**
```yaml
volumeMounts:
  - name: mongodb-ca
    mountPath: /etc/mongodb-ca
    readOnly: true

volumes:
  - name: mongodb-ca
    configMap:
      name: mongodb-ca-bundle
```

## MongoDB Server Configuration

The MongoDB deployment uses the following TLS settings (configured in `mongodb-deployment.yaml`):

- **TLS Mode**: `preferTLS` - accepts both TLS and non-TLS connections
- **Certificate**: Auto-generated by OpenShift service-serving CA
- **Client Certificates**: Not required (`--tlsAllowConnectionsWithoutCertificates`)
- **CA Bundle**: Injected into `mongodb-ca-bundle` ConfigMap via OpenShift annotation

## Why Fully Qualified Domain Name (FQDN)?

The connection uses `mongodb.f6e00d-dev.svc` instead of just `mongodb` because:

1. OpenShift's service-serving certificates include these Subject Alternative Names (SANs):
   - `mongodb.f6e00d-dev.svc`
   - `mongodb.f6e00d-dev.svc.cluster.local`

2. The certificate does **not** include the short name `mongodb`

3. TLS certificate validation requires the hostname to match the certificate SANs exactly

4. Using the FQDN ensures proper certificate validation and prevents man-in-the-middle attacks

## Authentication Configuration

MongoDB users are created in a specific database and must authenticate against that database.

**Connection String Parameter:**
```
?authSource=sampledb
```

This tells MongoDB to authenticate the user credentials against the `sampledb` database, where the user was created by the init script.

## Testing TLS Connection

### From MongoDB Test Pod

```bash
mongosh "mongodb://$MONGODB_USER:$MONGODB_PASSWORD@mongodb.f6e00d-dev.svc:$MONGODB_PORT/$MONGO_INITDB_DATABASE?authSource=$MONGO_INITDB_DATABASE&tls=true&tlsCAFile=/etc/mongodb-ca/service-ca.crt" \
  --eval "db.adminCommand('ping')"
```

Expected: `{ ok: 1 }`

### From NestJS Middleware Pod

```bash
POD_NAME=$(oc get pods -n f6e00d-dev -l app=social-middleware -o jsonpath='{.items[0].metadata.name}')

oc exec -it $POD_NAME -n f6e00d-dev -- node -e "
const mongoose = require('mongoose');
const uri = 'mongodb://' + process.env.MONGO_USER + ':' + process.env.MONGO_PASS + '@' + process.env.MONGO_HOST + ':' + process.env.MONGO_PORT + '/' + process.env.MONGO_DB + '?authSource=' + process.env.MONGO_DB;

mongoose.connect(uri, {
  tls: true,
  tlsCAFile: process.env.MONGO_TLS_CA_FILE
}).then(() => {
  console.log('TLS Connection Successful');
  return mongoose.connection.close();
}).then(() => process.exit(0))
  .catch(err => {
    console.error('Error:', err.message);
    process.exit(1);
  });
"
```

Expected: `✅ TLS Connection Successful`

## Verifying Certificate Validation

To verify that certificate validation is actually working, try connecting **without** the CA file:

```bash
oc exec -it $POD_NAME -n f6e00d-dev -- node -e "
const mongoose = require('mongoose');
const uri = 'mongodb://' + process.env.MONGO_USER + ':' + process.env.MONGO_PASS + '@' + process.env.MONGO_HOST + ':' + process.env.MONGO_PORT + '/' + process.env.MONGO_DB + '?authSource=' + process.env.MONGO_DB;

mongoose.connect(uri, {
  tls: true,
  tlsAllowInvalidCertificates: false
  // Note: No tlsCAFile specified
}).then(() => {
  console.log('❌ UNEXPECTED: Connected without CA file');
  process.exit(1);
}).catch(err => {
  console.log('✅ EXPECTED: Connection failed without CA file');
  console.log('   This proves certificate validation is working!');
  process.exit(0);
});
"
```

Expected: Connection should fail, proving that certificate validation is enforced.

## Security Benefits

✅ **Encryption in Transit**: All data between middleware and MongoDB is encrypted using TLS

✅ **Certificate Validation**: Prevents man-in-the-middle attacks by validating server certificates

✅ **Automatic Certificate Rotation**: OpenShift manages certificate lifecycle automatically

✅ **No Hardcoded Secrets**: Certificates managed by OpenShift, not stored in code

✅ **Environment Flexibility**: Can disable TLS for local development while enforcing it in production

## Troubleshooting

### "Authentication failed" Error

**Cause**: Missing or incorrect `authSource` parameter

**Solution**: Ensure connection string includes `?authSource=<database>` where `<database>` matches where the user was created

### Certificate Validation Errors

**Cause**: Using short hostname instead of FQDN

**Solution**: Use `mongodb.f6e00d-dev.svc` instead of `mongodb`

### "No such file or directory: /etc/mongodb-ca/service-ca.crt"

**Cause**: ConfigMap not mounted in pod

**Solution**: Verify Helm deployment includes volume mount for `mongodb-ca-bundle`

### Connection Works in Test Pod but Not in Application

**Cause**: Environment variables not set correctly in application deployment

**Solution**: Check that `MONGO_HOST`, `MONGO_USE_TLS`, and `MONGO_TLS_CA_FILE` are set in deployment

## Deployment Checklist

When deploying to a new environment:

- [ ] Ensure `mongodb-ca-bundle` ConfigMap exists (created by Helm chart)
- [ ] Verify MongoDB service has annotation: `service.beta.openshift.io/serving-cert-secret-name: mongodb-tls`
- [ ] Check that `mongodb-tls` secret was auto-generated by OpenShift
- [ ] Confirm `mongodb-init-user-job` completed successfully
- [ ] Verify middleware deployment mounts `mongodb-ca-bundle` ConfigMap
- [ ] Check environment variables are set correctly in middleware pod
- [ ] Test connection using the test commands above

## Files Modified

| File | Purpose |
|------|---------|
| `social-middleware/src/database/database.module.ts` | Added TLS configuration logic |
| `social-middleware/.env.example` | Added TLS environment variables |
| `social-middleware-helm/templates/nextjs-deployment.yaml` | Mounted CA certificate and set env vars |
| `social-middleware-helm/templates/mongodb-ca-configmap.yaml` | ConfigMap for CA bundle (created in earlier commit) |
| `social-middleware-helm/templates/mongodb-deployment.yaml` | MongoDB TLS configuration (created in earlier commit) |
| `social-middleware-helm/templates/mongodb-service.yaml` | Added cert annotation (created in earlier commit) |

## References

- [MongoDB TLS/SSL Configuration](https://docs.mongodb.com/manual/tutorial/configure-ssl/)
- [OpenShift Service Serving Certificates](https://docs.openshift.com/container-platform/latest/security/certificates/service-serving-certificate.html)
- [Mongoose TLS Options](https://mongoosejs.com/docs/connections.html#options)

---

**Document Version**: 1.0
**Last Updated**: 2025-11-13
**Related Commit**: `6dbc3fd` (seeded tls encrypting for mongodb)
chridodd@netwon:~/social-middleware$
