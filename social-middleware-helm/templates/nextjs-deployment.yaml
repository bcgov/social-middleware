apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.nextjs.podlabel }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ .Values.nextjs.podlabel }}
spec:
  {{- if not (hasSuffix "-prod" .Release.Namespace) }}
  replicas: {{ .Values.nextjs.replicas | default 2 }}
  {{- end }}
  selector:
    matchLabels:
      app: {{ .Values.nextjs.podlabel }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 25%
      maxSurge: 25%
  revisionHistoryLimit: 10
  progressDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app: {{ .Values.nextjs.podlabel }}
    spec:
      initContainers:
        - name: wait-for-mongodb
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for MongoDB to be ready..."
              {{- if hasSuffix "-prod" .Release.Namespace }}
              # In prod, wait for all 3 replica set members
              until nc -z mongodb-0.{{ .Values.mongodb.podlabel }}.{{ .Release.Namespace }}.svc.cluster.local 27017 && \
                    nc -z mongodb-1.{{ .Values.mongodb.podlabel }}.{{ .Release.Namespace }}.svc.cluster.local 27017 && \
                    nc -z mongodb-2.{{ .Values.mongodb.podlabel }}.{{ .Release.Namespace }}.svc.cluster.local 27017; do
                echo "Waiting for MongoDB replica set members..."
                sleep 2
              done
              echo "All MongoDB replica set members are ready"
              {{- else }}
              # In dev, wait for single instance
              until nc -z {{ .Values.mongodb.podlabel }} 27017; do
                echo "Waiting for MongoDB..."
                sleep 2
              done
              echo "MongoDB is ready"
              {{- end }}
        - name: wait-for-redis
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Redis to be ready..."
              until nc -z redis 6379; do
                echo "Waiting for Redis..."
                sleep 2
              done
              echo "Redis is ready"
      containers:
        - name: nextjs
          image: 'image-registry.openshift-image-registry.svc:5000/f6e00d-tools/nextjs:{{ (last (splitList "-" .Release.Namespace)) }}'
          imagePullPolicy: Always
          ports:
            - containerPort: {{ .Values.nextjs.port }}
              protocol: TCP
          env:
            - name: MONGO_USER
              valueFrom:
                secretKeyRef:
                  name: mongodb
                  key: database-user
            - name: MONGO_PASS
              valueFrom:
                secretKeyRef:
                  name: mongodb
                  key: database-password
            - name: MONGO_DB
              valueFrom:
                secretKeyRef:
                  name: mongodb
                  key: database-name
            - name: MONGO_HOST
              {{- if hasSuffix "-prod" .Release.Namespace }}
              value: "mongodb-0.{{ .Values.mongodb.podlabel }}.{{ .Release.Namespace }}.svc.cluster.local:27017,mongodb-1.{{ .Values.mongodb.podlabel }}.{{ .Release.Namespace }}.svc.cluster.local:27017,mongodb-2.{{ .Values.mongodb.podlabel }}.{{ .Release.Namespace }}.svc.cluster.local:27017"
              {{- else }}
              value: "{{ .Values.mongodb.podlabel }}.{{ .Release.Namespace }}.svc"
              {{- end }}
            - name: MONGO_PORT
              value: "{{ .Values.mongodb.port }}"
            - name: MONGO_USE_TLS
              value: "true"
            - name: MONGO_TLS_CA_FILE
              value: "/etc/mongodb-ca/service-ca.crt"
            {{- if hasSuffix "-prod" .Release.Namespace }}
            - name: MONGO_REPLICA_SET
              value: "rs0"
            {{- end }}
            - name: REDIS_HOST
              valueFrom:
                secretKeyRef:
                  name: redis
                  key: host
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis
                  key: password
          envFrom:
            - secretRef:
                name: frontend
            - secretRef:
                name: bcsc
            - secretRef:
                name: siebel
            - secretRef:
                name: ches
          volumeMounts:
            - name: mongodb-ca
              mountPath: /etc/mongodb-ca
              readOnly: true
          resources:
            {{- if hasSuffix "-prod" .Release.Namespace }}
            limits:
              cpu: {{ .Values.nextjs.prod.resources.limits.cpu | quote }}
              memory: {{ .Values.nextjs.prod.resources.limits.memory }}
            requests:
              cpu: {{ .Values.nextjs.prod.resources.requests.cpu | quote }}
              memory: {{ .Values.nextjs.prod.resources.requests.memory }}
            {{- else }}
            limits:
              cpu: {{ .Values.nextjs.dev.resources.limits.cpu | quote }}
              memory: {{ .Values.nextjs.dev.resources.limits.memory }}
            requests:
              cpu: {{ .Values.nextjs.dev.resources.requests.cpu | quote }}
              memory: {{ .Values.nextjs.dev.resources.requests.memory }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: /health
              port: {{ .Values.nextjs.port }}
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: {{ .Values.nextjs.port }}
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /health
              port: {{ .Values.nextjs.port }}
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 30
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
      volumes:
        - name: mongodb-ca
          configMap:
            name: mongodb-ca-bundle
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      dnsPolicy: ClusterFirst
      securityContext: {}
      schedulerName: default-scheduler
